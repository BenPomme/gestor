// Gestor√≠a Copilot - Database Schema
// Based on SPEC2.md data model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Language {
  en
  es
  ca
}

enum ResidencyStatus {
  citizen
  resident
  non_resident
  pending
}

enum Relationship {
  spouse
  partner
  child
  parent
  sibling
  other
}

enum PadronStatus {
  not_registered
  registered
  expired
  pending
}

enum DocumentStatus {
  pending_ocr
  processing
  processed
  error
}

enum DocumentType {
  padron_certificate
  nie_certificate
  tax_notice
  traffic_fine
  beckham_notification
  modelo_149
  modelo_151
  rental_contract
  utility_bill
  bank_statement
  employment_contract
  other
}

enum ProcessCategory {
  padron_individual
  padron_familiar
  beckham
  traffic_fine
  tax_notice
  tax_filing
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum ChatRole {
  user
  assistant
  system
}

enum SubscriptionPlan {
  free
  basic
  family
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  incomplete
  trialing
}

enum TemplateType {
  padron_request
  padron_familiar_consent
  beckham_employer_letter
  traffic_fine_appeal
  tax_info_request
  general_inquiry
}

// ============================================
// MODELS
// ============================================

model User {
  id                String          @id @default(uuid())
  email             String          @unique
  passwordHash      String          @map("password_hash")
  name              String
  preferredLanguage Language        @default(en) @map("preferred_language")
  region            String?
  city              String?
  residencyStatus   ResidencyStatus? @map("residency_status")
  nieOrPassport     String?         @map("nie_or_passport")
  taxResidencyDate  DateTime?       @map("tax_residency_date")
  emailVerified     Boolean         @default(false) @map("email_verified")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  dependents     Dependent[]
  documents      Document[]
  tasks          Task[]
  chatMessages   ChatMessage[]
  subscription   Subscription?
  refreshTokens  RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Dependent {
  id                String          @id @default(uuid())
  userId            String          @map("user_id")
  name              String
  relationship      Relationship
  birthdate         DateTime?
  nieOrPassport     String?         @map("nie_or_passport")
  residencyStatus   ResidencyStatus? @map("residency_status")
  padronStatus      PadronStatus?   @map("padron_status")
  padronDate        DateTime?       @map("padron_date")
  keyDates          Json?           @map("key_dates")
  preferredLanguage Language?       @map("preferred_language")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]
  tasks     Task[]

  @@map("dependents")
}

model Document {
  id                   String         @id @default(uuid())
  userId               String         @map("user_id")
  dependentId          String?        @map("dependent_id")
  storagePathRaw       String         @map("storage_path_raw")
  storagePathProcessed String?        @map("storage_path_processed")
  status               DocumentStatus @default(pending_ocr)
  language             Language?
  senderAuthority      String?        @map("sender_authority")
  referenceNumbers     Json?          @map("reference_numbers")
  amountEur            Decimal?       @map("amount_eur") @db.Decimal(10, 2)
  deadlineDate         DateTime?      @map("deadline_date")
  taxYear              Int?           @map("tax_year")
  isBeckhamRelated     Boolean        @default(false) @map("is_beckham_related")
  isPadronFamiliar     Boolean        @default(false) @map("is_padron_familiar")
  docType              DocumentType?  @map("doc_type")
  processId            String?        @map("process_id")
  summaryByLanguage    Json?          @map("summary_by_language")
  structuredData       Json?          @map("structured_data")
  ocrText              String?        @map("ocr_text")
  confidence           Float?
  createdAt            DateTime       @default(now()) @map("created_at")
  processedAt          DateTime?      @map("processed_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dependent Dependent? @relation(fields: [dependentId], references: [id], onDelete: SetNull)
  process   Process?   @relation(fields: [processId], references: [id], onDelete: SetNull)
  tasks     Task[]

  @@index([userId])
  @@index([status])
  @@index([deadlineDate])
  @@map("documents")
}

model Process {
  id           String          @id @default(uuid())
  slug         String          @unique
  category     ProcessCategory
  country      String          @default("ES")
  region       String?
  city         String?
  titles       Json            // { en: "", es: "", ca: "" }
  descriptions Json            // { en: "", es: "", ca: "" }
  steps        Json            // ProcessStep[]
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  documents Document[]
  tasks     Task[]
  templates Template[]

  @@index([category])
  @@map("processes")
}

model Task {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  dependentId String?      @map("dependent_id")
  processId   String?      @map("process_id")
  documentId  String?      @map("document_id")
  title       String
  description String?
  dueDate     DateTime?    @map("due_date")
  status      TaskStatus   @default(pending)
  priority    TaskPriority @default(medium)
  createdAt   DateTime     @default(now()) @map("created_at")
  completedAt DateTime?    @map("completed_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dependent Dependent? @relation(fields: [dependentId], references: [id], onDelete: SetNull)
  process   Process?   @relation(fields: [processId], references: [id], onDelete: SetNull)
  document  Document?  @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      ChatRole
  content   String
  language  Language
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique @map("user_id")
  stripeCustomerId     String             @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  plan                 SubscriptionPlan   @default(free)
  status               SubscriptionStatus @default(active)
  periodStart          DateTime?          @map("period_start")
  periodEnd            DateTime?          @map("period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Template {
  id                 String       @id @default(uuid())
  type               TemplateType
  processId          String?      @map("process_id")
  language           Language
  name               String
  body               String
  placeholdersSchema Json         @map("placeholders_schema")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  // Relations
  process Process? @relation(fields: [processId], references: [id], onDelete: SetNull)

  @@index([type])
  @@map("templates")
}
